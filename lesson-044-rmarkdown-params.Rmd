---
params:
  geo_id: NL BE
  month: February March April May June July August September October November December
  year: 2020
---
# Lesson 4.4 - RMarkdown - parameters {#rmarkdownparams}

_This chapter is best read from the source RMarkdown file_

## Lesson Contents

 - Advanced Markdown syntax (images, links, references, cross-references)
 - Bibtex
 - Parameters (params in yaml header, params in chunks)
 - Using Shiny interactive elements in RMarkdown
 - Using `rmarkdown::render()` to render one or multiple paramterized reports
 - Deployment / setting up Github pages for your portfolio
 - Automating deployment - github actions
 - Bookdown / blogdown
 
 ## Resources

 - https://github.com/r-lib/actions/blob/master/examples/README.Rmd
 - https://rmarkdown.rstudio.com/developer_parameterized_reports.html%23parameter_types%2F
 - https://bookdown.org/yihui/rmarkdown/parameterized-reports.html
 - [github actions for R](https://community.rstudio.com/t/github-actions-for-r-introducing-the-ghactions-package/23571) 
 - https://bookdownplus.netlify.app/portfolio/

## Introduction

RMarkdown is R's answer to doing reproducible research. In this lesson we take the next step in customization of RMardown reports. First we introduce a number of addiotnial formatting, style and technical capabilites in RMarkdown to increase productivity and creativity with RMarkdown. 
Furthermore, we will see that RMarkdown can used for a number of semi- and fully automated reporting workflows. We will start with a user side definition of parameters that can be used to render documents and run code inside Rmd files that can be varied on the basis of user-defined input. Next step in complexity is to move to interactive Shiny elements build into an RMarkdown file, approaching the development of App-like documents or websites. Than we introduce the `{bookdown}` and `{blogdown}` package as publication frameworks for publishing reports, books, websites and blogs. You will learn how to setup your own website to host data products that will help you show your skills as a programmer/bioinformatician. This can be very helpfull in finding a job.     
Last step in complexity that we will add is to setup Continuous Integration (CI) for publishing data products, directly from RStudio. We will again use build-in functionality in Github.com com for this (Github actions).

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo = TRUE,
  warning = FALSE,
  message = FALSE,
  error = FALSE
  
  )
```

```{r, include=FALSE}
## Packages
library(utils)
library(tidyverse)
library(tools)
library(glue)
library(readxl) 
library(httr) 
library(zoo)
library(blscrapeR)
```

 - Advanced Markdown syntax (images, links, references, cross-references)
 - Bibtex
 - Parameters (params in yaml header, params in chunks)
 - Using Shiny interactive elements in RMarkdown
 - Using `rmarkdown::render()` to render one or multiple paramterized reports
 - Deployment / setting up Github pages for your portfolio
 - Bookdown / blogdown
 - Automating deployment - github actions


## Data
```{r, echo=TRUE}
## Read data from public url to csv file
data <- readr::read_csv(
  "https://opendata.ecdc.europa.eu/covid19/casedistribution/csv/data.csv", 
  na = c("", " "))
data
```

## Data cleaning
```{r}

data <- data %>%
  mutate(
    date = lubridate::dmy(dateRep),
    ) %>%
  separate(
    col = date, 
    into = c("year", "month", "day"), remove = FALSE) %>%
  mutate(
    month = as.integer(month)
  )



## Filter for `r params$month` and `r params$geo_id`
## create a conversion table to go from month name to month integer
convert_months <- tibble(
  month = c(
    "january",
    "february",
    "march",
    "april",
    "may",
    "june",
    "july",
    "august",
    "september",
    "october",
    "november",
    "december"),
  month_number = c(1:12))

  m_names <- str_split(tolower(params$month), pattern = " ") %>% 
    unlist() %>%
    enframe() 

  month_id <- convert_months %>%
    dplyr::filter(
      month %in% m_names$value) 
  #%>% 
  #  dplyr::select(month_number)
  
  id <- month_id$month_number

geo_ids <- str_split(string = params$geo_id, pattern = " ") %>% unlist()

data_filter <- data %>%
  dplyr::filter(
    month %in% id,
     geoId %in% geo_ids
)
  
char_col <- map_lgl(
  .x = data_filter,
  .f = is.numeric 
)

#map(
#  .x = data_filter[, !char_col],
#  .f = unique
#)

country_names <- data_filter$countriesAndTerritories %>% unique() %>%
  paste(collapse = ", ")

Caps <- function(x) {
s <- strsplit(x, " ")[[1]]
paste(toupper(substring(s, 1,1)), substring(s, 2),
sep="", collapse=" ")
}

range <- data_filter$month %>% unique() %>% enframe() %>%
  arrange(value)

month_df <- left_join(range, convert_months, by = c("value" = "month_number")) %>%
  dplyr::mutate(month = firstupper(month))

min_month <- month_df %>%
  dplyr::filter(value == min(month_df$value))

countries_vec <- str_split(
  country_names, 
  pattern = ",", 
  simplify = FALSE
  ) %>%
  unlist() %>%
  trimws() %>%
  blscrapeR::firstupper()  
  

max_month <- month_df %>%
  dplyr::filter(value == max(month_df$value))

cap_cases <- paste(
  "COVID-19 positive cases from", 
  min_month$month, "to", max_month$month,
  "for", glue_collapse(countries_vec, ", ", last = " and ")
)

cap_deaths <- paste(
  "COVID-19 related deaths from", 
  min_month$month, "to", max_month$month,
  "for", glue_collapse(countries_vec, ", ", last = " and ")
)


data_filter  
```

## Cases
```{r, fig.cap=cap_cases}
set.seed(123)
#data_filter <- data_filter %>% 
#  mutate(date_time = lubridate::dmy(dateRep))  %>%  # Moving average
#  mutate(cases_ma = zoo::rollmean(cases, k = 7, fill = NA))


#names(data_filter)
plot_cases <- data_filter %>%
  na.omit() %>%
  ggplot(aes(x = date, y = cases_weekly)) +
  geom_point(aes(colour = geoId)) +
  geom_line(aes(group = geoId, colour = geoId)) +
  xlab("Date") +
  ylab("COVID-19 positive tested cases") +
  theme_bw()

plot_cases



```

## Deaths
```{r, fig.cap=cap_deaths}
set.seed(123)

#data_filter <- data_filter %>% 
#  mutate(date_time = lubridate::dmy(dateRep)) %>%  # Moving average
#  mutate(deaths_ma = zoo::rollmean(deaths, k = 7, fill = NA))

#names(data_filter)
plot_deaths <- data_filter %>%
  ggplot(aes(x = date, y = deaths_weekly)) +
  geom_point(aes(colour = geoId)) +
  geom_line(aes(group = geoId, colour = geoId))  +
  xlab("Date") +
  ylab("COVID-19 related deaths") +
  theme_bw()

plot_deaths

```

## Interactive plot
```{r}

```




